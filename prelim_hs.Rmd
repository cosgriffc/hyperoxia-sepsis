---
title: "Hyperoxia & Sepsis: Preliminary Report"
author: "C. V. Cosgriff, MD/MPH Student, Harvard Chan School"
output:
  pdf_document: default
---

## Libraries
```{r warning = FALSE, message = FALSE}
library(RPostgreSQL)
library(tidyverse)
library(MIMICbook)
library(tableone)
library(sjPlot)
library(broom)
```

## Database 
```{r message = FALSE, warning = FALSE}

drv <- dbDriver("PostgreSQL")
mimic <- dbConnect(drv, dbname = "mimic", host = mimichost, port = 5432,
                   user = "mimicuser", password = pw )
```

## Load the Data
The dataset was generated in multiple steps; these are found  cohort3.sql. 
Because of a computational limitation, we couldn't pull directly from Postgres 
for the SpO2 items.
```{r, warning = FALSE, message = FALSE}
cohort.df <- dbGetQuery(mimic, 
                        "SELECT * FROM mimiciii.hyperoxia_sepsis_covariates2")

colnames.spo2 <- c("row_id", "subject_id", "hadm_id", "icustay_id",
                   "charttime", "ventstart", "ventend", "valuenum")
spo2.df <- read_csv("D:/HST953_data/hyperoxia_sepsis_spo2.csv", col_names = colnames.spo2)
```


## Cleaning the Data: Part 1
```{r}
spo2.df[spo2.df$valuenum > 100,]$valuenum
length(spo2.df[spo2.df$valuenum > 100,]$valuenum)
```

There are 72 value sgreater than 100 or NA; they can be thrown out as they are a
very small fraction of the 374k. We can also disregard any values under 94 as we
only kept patients with <2 readings under that making the assumption that those 
first two could be recording error or a loose pulse ox.
```{r}
spo2.tidy.df <- spo2.df %>% filter(valuenum <= 100 & valuenum >= 94) %>%
  na.omit()
```

We want to also check if there any vent stretches for which only one SpO2 recording
occurred; this should be rare considering we exclude anyone with <4h on the vent.
## 
```{r}
spo2.count.df <- spo2.tidy.df %>% group_by(icustay_id) %>% 
  summarize(count = n()) %>% filter(count < 4)
print(spo2.count.df)
```

There was only one ICU stay with this problem, and this was the only ICU stay
for that patient, and so we'll remove it.
```{r}
cohort.df <- cohort.df %>% filter(!(cohort.df$icustay_id %in% spo2.count.df$icustay_id))
spo2.tidy.df <- spo2.tidy.df %>% filter(!(spo2.tidy.df$icustay_id %in% spo2.count.df$icustay_id))
```

MIMIC-III codes age > 89 as ~300 to protect confientiality, and the manual says
the median age for that group was 91.4. We'll also code gender M = 1, F = 0.
```{r}
cohort.df[cohort.df$age > 89, "age"] <- 91.4
cohort.df$gender <- as.numeric(cohort.df$gender == "M")
```

Before we cleanup the data further, we need to pull in the SpO2 recordings and
create hyperoxic durations.

## Hyperoxic Durations

### Duration of Exposure
In order to create one dataframe, we need to calculate the duration of exposure 
for each ICU stay, and so a function to determine this was developed. Intervals
are developed from chart times, and SpO2 values are considered constant between 
each interval.
```{r}
hyperoxicTime<- function(times, value) {
  icustay.spO2 <- data.frame(time = times, value = value)
  icustay.spO2 <- icustay.spO2[order(icustay.spO2$time),]
  intervals <- as.numeric(icustay.spO2$time - lag(icustay.spO2$time))
  intervals <- lead(intervals)
  intervals[is.na(intervals)] <- 0
  # Intervals are usually ~60, we will tolerate as many as three missed entries
  # or other errors; beyond that the result will be tossed.
  intervals[intervals >= 3*60] <- 0
  icustay.spO2 <- icustay.spO2 %>% mutate(duration = intervals)
  o2levels <- icustay.spO2 %>% group_by(value) %>% 
    summarize(time_at = as.numeric(sum(duration))) %>% arrange(desc(value))
  o2levels[is.na(o2levels)] <- 0
  colnames(o2levels)[1] <- "satValue"
  dur.100 <- as.numeric(o2levels[o2levels$satValue == 100, 2])
  dur.99 <-  as.numeric(o2levels[o2levels$satValue == 99, 2])
  if (is.null(dur.100) | length(dur.100) <= 0) {
    dur.100 <- 0
  }
    if (is.null(dur.99) | length(dur.99) <= 0) {
    dur.99 <- 0
  }
  if (is.na(dur.100)) {
    dur.100 <- 0
  }
  if (is.na(dur.99)) {
    dur.99 <- 0
  }
  (dur.100 + dur.99) / 60
}
```

With this function, durations of hyperoxia (>98%) were calcualted for each ICU 
stay ID.
```{r}
spo2.profiled <- spo2.tidy.df %>% 
  group_by(icustay_id) %>% 
  summarize(hyperoxic_dur = as.numeric(hyperoxicTime(charttime, valuenum)))
```

Now we can data merged with our cohort data on icustay_id.
```{r}
hs.df <- inner_join(cohort.df, spo2.profiled, by = "icustay_id")
```


## Cleaning Part 2

There are ~290 patients in the cohort who have multiple hospital admissions. 
This is a problem: consider a patient who comes into the hospital in February,
is discharged, and then returns in March, and is discharged again. Consider this
patient dies in June. Now consider that they had a significant amount of the
exposure in the first stay but not the second. They would therefore be in both
arms of the study and produce only 1 outcome. Instead, we could look at first
admission or throw these patients out. We'll start with throwing them out,
and store a frame with earliest for sensitivity analysis later.


```{r}
# To remove, we need a list of subject IDs of any patient with more than one
# admission.
check <- hs.df %>% group_by(subject_id) %>% summarize(count = n())
check <- check %>% filter(count < 2)
hs.df <- hs.df[hs.df$subject_id %in% check$subject_id,]

# This was a way of just including the earliest; we'll look at this in 
# sensitivity analysis.
#hs.firstAdmit.df <- hs.df %>% group_by(subject_id) %>% 
#  filter(admittime == min(admittime))

```

We have multiple ICU stays per hospital admission but eventually just want to 
examine a subjects one-year mortality following their discharge; so we'll summarize
their ICU stays into one admission with the following logic:
Because the OASIS score is calculated for each ICU stay, we'll take
use their highest OASIS as the OASIS for the overall admission. Also note, we
take the average of age, but it should be virtually identical across the admission.
Elixhauser doesn't change by ICU stay, and we assign pressors based on if it
they were given during any stay.
```{r}
hs.df <- hs.df %>% group_by(subject_id, hadm_id, admittime, gender, elixhauser) %>%
  summarize(oasis = max(oasis), age = mean(age), vasopressor_flag = as.numeric(any(vasopressor_flag == 1)),
            icu_los = sum(icu_length_of_stay), vent_dur = sum(vent_duration), 
            hyperoxic_dur = sum(hyperoxic_dur), hospital_expire = as.numeric(any(hospital_expire_flag == 1)),
            oneyear_expire = as.numeric(any(one_year_expire == 1)))
```

Our extraction contains data on hospital expiration in the event we want to examine
this as a secondary outcome. For now though we will proceed by removing any 
patient who died in the hospital. So our cohort is patients who survive their
hospitalization, and we are curious about one year mortality.
```{r}
#hs.df <- hs.df %>% filter(hospital_expire == 0) %>% ungroup()
hs.df <- hs.df  %>% ungroup()
```

Our vent and hyperoxic durations are in hours, but the extracted LOS is in days;
will flip it to hours for ease of comparison.

```{r}
hs.df$icu_los <- hs.df$icu_los * 24
```


Lastly, Leo wanted to examine hyperoxia as a categorical variable. To do this,
we'll generate groups based on quartiles with the bottom quartile as group 1 and
the top quartile as group 4. We'll do the same for ventilation in case we are 
curious about it later.
```{r}
groups <- 4
hs.df$hyperoxic_quartile <- 0
hs.df$hyperoxic_group <- 0

hs.df$hyperoxic_quartile <- with(hs.df, cut(hyperoxic_dur, 
                                breaks = quantile(hyperoxic_dur, 
                                                  probs = seq(0,1, by = (1/groups)), 
                                                  na.rm=TRUE), 
                                include.lowest = TRUE))

hyperoxia.levels <- levels(hs.df$hyperoxic_quartile)

for (i in 1:groups) {
  hs.df$hyperoxic_group[hs.df$hyperoxic_quartile == hyperoxia.levels[i]] <- i
}
```


Now, just to reorganize the data.
```{r}
hs.df <- hs.df %>% select(subject_id, age, gender, elixhauser, icu_los, oasis, 
                          vasopressor_flag, vent_dur, hyperoxic_dur, 
                          hyperoxic_group, hospital_expire, oneyear_expire)
```

## Exploratory Data Analysis

### Covariates
Lets convert are binary variables to factors.
```{r}
hs.eda.df <- hs.df
hs.eda.df$gender <- as.factor(hs.eda.df$gender)
hs.eda.df$vasopressor_flag <- as.factor(hs.eda.df$vasopressor_flag)
hs.eda.df$hyperoxic_group <- as.factor(hs.eda.df$hyperoxic_group)
hs.eda.df$hospital_expire <- as.factor(hs.eda.df$hospital_expire)
hs.eda.df$oneyear_expire <- as.factor(hs.eda.df$oneyear_expire)
```


And now lets generate a Table 1.
```{r}
CreateTableOne(vars=c("age","gender", "elixhauser", "icu_los", "oasis", "vasopressor_flag","vent_dur", "hyperoxic_dur", "hyperoxic_group"),
               data=hs.eda.df)
```

And because we will be analyzing these patients based on hyperoxic group, lets
see if there are differences between the covariates by group.
```{r}
CreateTableOne(vars=c("age","gender", "elixhauser", "icu_los", "oasis",
                      "vasopressor_flag","vent_dur"), strata = "hyperoxic_group",
               data=hs.eda.df)
```

All covariates vary by hyperoxic_group, and clearly will need to be controlled 
for.

As expected, they appear quite related. 

### Other Questions
Before proceeding to examine the outcomes, some useful questions to answer are:

1) How many SpO2 readings are there per patient on average (which we used to
build the durations)?
```{r}
readings.count <- spo2.tidy.df %>% group_by(subject_id) %>% 
  summarise(count = n())
summary(readings.count$count)
```

On average there are ~99 readings with a median of 54 and no less than 4; there
is therefore a good amount of data per patient. And the distributon:

```{r}
ggplot(readings.count) + geom_histogram(aes(x = count))
```


2) What does the distribution of SpO2, hyperoxia duration, ventilation duration
look like?
```{r}
ggplot(spo2.tidy.df) + geom_histogram(aes(x = valuenum), binwidth = 1)
ggplot(hs.eda.df) + geom_histogram(aes(x = hyperoxic_dur))
ggplot(hs.eda.df) + geom_histogram(aes(x = vent_dur))
```

3) Are hyperoxic duration, vent duration, and LOS as related as we would expect?

```{r}
ggplot(hs.eda.df) + geom_point(aes(x= hyperoxic_dur, y = vent_dur,
                                   size = icu_los, alpha = 0.5))
```


### Outcomes

#### Primary outcome 1: Hospital Expiration
Lets now see the proportion of patients in each group who achieved the ouctome.
```{r}
plot_prop_by_level(hs.eda.df,"hyperoxic_group","hospital_expire")
```


Based on this, at least unadjusted, there appears to be a difference; lets look
at crude odds ratio by group.

```{r}
plot_OR_by_level(hs.eda.df, "hyperoxic_group","hospital_expire")
```


There is a dip at hyperoxic_group 2, followed by increases in level 3 and 4.
This is physiologically acceptable as some hyperoxia may be helpful, but at some
point it may become detrimental.

We'll examine this exposure/outcome relationship with model building after
exploring the second primary outcome.

#### Primay Outcome 2: One-year Expire

Lets now see the proportion of patients in each group who achieved the ouctome.
```{r}
plot_prop_by_level(hs.eda.df,"hyperoxic_group","oneyear_expire")
```

Based on this, at least unadjusted, there appears to be a difference in group 
3 and 4, although 4 is actually lower than 3. Lets check the OR.

```{r}
plot_OR_by_level(hs.eda.df, "hyperoxic_group","oneyear_expire")
```

The pattern persists: group 3 is worse than 2 or 4; this makes less sense than
our previous outcome which seemed plausible. This will have to probed further.

## Model Building

### Hopsital Expiration

We'll build a logistic regression model for the outcome of hospital expiration
and the exposure of hyperoxic group. We will adjust for age, gender, length of
ICU stay, total duration of ventilation, highest ICU first day OASIS, elixhauser,
and the presence or absence of vasopressors at anytime during their ICU stays.

These covariates were picked based upon expert opinion and the model wil not be
built in a sequential manner, but rather include all covariates from the start.

The reference group is hyperoxic group 1, the lowest quartile of exposure.

```{r}
hs.he.glm <- glm(hospital_expire ~ hyperoxic_group + age + gender + icu_los +
                   vent_dur + oasis + elixhauser + vasopressor_flag,
                 family = binomial(link = "logit"), data = hs.eda.df)

summary(hs.he.glm)
```

Lets check the ORs and CI for the ORs.
```{r}
exp(hs.he.glm$coefficients)
exp(confint(hs.he.glm))
```

The OR of hospital death for hyperoxic group 2 is 0.74 [0.43 1.25], for group 3 
is 1.62 [1.04, 2.56], and for group 4 is 2.30 [1.34, 3.98] when adjusted for
age, gender, ICU length of stay, total ventilation duration, OASIS, elixhauser,
and vasopressors during ICU course.

Within the conventional hypothesis testing framework utilizing an alpha of 0.05,
the p-values for the test of the coefficients for our three groups as compared
to the reference group (hyperoxic group 1) and adjusted for all covariates are
0.262, 0.0363, and 0.003 respectively. 

Thus, for hyperoxic groups 3 & 4, the data is inconsistent with the state of 
nature described by the null. There is particularly strong evidence against the
null for group 4.

### One year expire

```{r}
hs.oye.glm <- glm(oneyear_expire ~ hyperoxic_group + age + gender + icu_los +
                   vent_dur + oasis + elixhauser + vasopressor_flag,
                 family = binomial(link = "logit"), data = hs.eda.df)
summary(hs.oye.glm)
```

The above result recapitulates what occured earlier; while all groups have an
OR > 1, there appears to be a trend that contradicts our expected relationship.
The third group is highly significant, but for some reason group 4 is not. 
